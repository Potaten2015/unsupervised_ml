%% Assignment 7
% Taten Knight

%% Cleanup
clear all;
close all;
clc;

%% Copied and updated from TSP_SOMS file
% Setup
numPoints = 12;
x = rand(numPoints, 2);
wStart=rand(numPoints,2);
alp=1;
convergence=.01;
nhFraction = .3; % What fraction of difference the neighbors move towards the winner
nhMax = 5;
diffs = cell(1, nhMax + 1);
weights = diffs;

if numPoints < 2 * nhMax + 1
    throw(MException('InputError:numPoints_nhMax', 'numpoints must be greater than or equal to 2 * nhMax + 1'))
end

%% Run with different numbers of neighbors
for nh = 0:nhMax
    diff=10;
    w = wStart;
    %TSP using SOM
    titleString = ['points-' num2str(numPoints) '-neighborhood-' num2str(nh) '-alpha-' num2str(alp) '-convergence-' num2str(convergence)];
    fig = figure();
    plot(x(:,1),x(:,2),'*')
    title(titleString);
    axis([0 1 0 1])
    hold
    for i = 1:numPoints
        text(x(i,1),x(i,2)+0.02,['C' num2str(i)])
    end

    % Iterative Loop

    while diff>convergence
        weights{nh + 1}(:, : , end) = [weights{nh + 1}; w];
        % Save old weights
        oldw=w;

        % Change order that we check node with
        order=randperm(numPoints);

        % For each node
        for i=1:numPoints
            % Distance vector = the distance between a random x and the weight,
            % w
            d=ones(numPoints,1)*x(order(i),:)-w;
            d=(d(:,1).^2+d(:,2).^2).^0.5;
            % m2 is the index of the vector with the minimum distance (aka the
            % closest node to the datapoint
            [m1 m2]=min(d);
            % Update the weight vectors within the neighborhood of the winning
            % vector (+-2)
            for d1=m2-nh:m2+nh
                modD1 = mod(d1, numPoints);
                if d1 == 0 || d1 == numPoints
                    modD1 = numPoints;
                end
                w(modD1,:)=w(modD1,:)+alp*(nhFraction ^ abs(d1 - m2))*(x(order(i),:)-w(modD1,:));
            end
        end
    % Calculate the current change in w
    diff=norm(oldw-w);
    diffs{nh + 1} = [diffs{nh + 1} diff];
    plot(w(:,1),w(:,2),'r')
    plot(w(:,1),w(:,2),'ro')
    hold on
    end
    
end